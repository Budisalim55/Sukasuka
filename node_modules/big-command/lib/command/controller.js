var controller = exports;

var cliff  = require('cliff'),
    prompt = require('prompt');

controller.get = function (id, data, resource) {
  if (id) {
    resource.get(id, function(err, result){
      if(err) {
        logger.error(JSON.stringify(err))
        return;
      }
      logger.info('showing ' + id.magenta);
      cliff.putObject(result);
    });
  } else {
    logger.error('id is required to get');
  }
}

controller.all = function (id, options, resource) {
  logger.info('listing ' + resource.name.magenta)
  resource.all(function(err, rows){
    if(err) {
      logger.error(JSON.stringify(err))
      return;
    }
    if (rows.length === 0) {
      logger.info('no ' + resource.name.magenta + ' found')
    } else {
      logger.info('showing all ' + resource.name.magenta);
      var lines = cliff.stringifyObjectRows(rows, Object.keys(resource.schema.properties), ['underline'], { columnSpacing: 5 }).split('\n');
      lines.forEach(function(line){
        logger.info(line);
      })
    }
  })
};

controller.create = function (id, data, resource) {
  
  logger.warn('prompting user for data');
  if(typeof prompt.override.id !== 'undefined') {
    logger.info('define ' + prompt.override.id.magenta);
  } else {
    logger.info('define new ' + resource.name.magenta);
  }
  prompt.get(resource.schema, function (err, result) {
    if(err) {
      return;
    }
    logger.info('about to create ' + resource.name.magenta);
    cliff.putObject(result);
    resource.create(result, function(err, r){
      if(err) {
        logger.error(JSON.stringify(err))
        return;
      }
      logger.info('created new ' + resource.name.magenta + ' ' + r.id.grey)
    })
  });
};

controller.edit = function (id, resource) {
  resource.get(id, function(err, record) {
    if(err) {
      logger.error(JSON.stringify(err))
      return;
    }
    var schema = utile.clone(resource.schema);
    for(var p in record.properties) {
      if(typeof schema.properties[p] !== 'undefined') {
        schema.properties[p].default = record.properties[p];
      }
    }
    logger.info('editing ' + resource.name.magenta + ' ' + record.id);
    logger.warn('prompting user for data');
    prompt.get(schema, function (err, result) {
      if(err) {
        return;
      }
      logger.info('about to save ' + resource.name.magenta);
      cliff.putObject(result);
      result.id = record.id;
      confirm(function(err, promptResult){
        resource.update(record.id, result, function(err, r){
          if(err) {
            return logger.error(JSON.stringify(err))
          }
          logger.info('saved ' + resource.name.magenta + ' ' + r.id.grey)
        })
      });
    });
  });
};

controller.destroy = function (id, resource) {
  resource.get(id, function(err, record){
    if(err) {
      logger.error(JSON.stringify(err))
      return;
    }
    var schema = utile.clone(resource.schema);
    logger.info('about to destroy ' + resource.name.magenta + ' ' + record.id);
    cliff.putObject(record);
    confirm(function(err, promptResult){
      resource.destroy(record.id, function(err, r){
        if(err) {
          logger.error(JSON.stringify(err))
          return;
        }
        logger.info('destroyed' + ' ' + r.id.magenta)
      });
    });
  });
};

controller.resourceMethod = function (id, method, resource) {

  var _args = [];

  logger.info('executing resource method ' + method.magenta);

  //
  // If there is a supplied schema for this resource method,
  // then prompt the user to fill out the schema
  //

  if(typeof resource[method].schema === 'object' && typeof resource[method].schema.properties === 'object') {
    var _schema = resource[method].schema;
    //
    // Check to see if the convention of an options / callback is used,
    // if not, just use the schema as is
    //
    _schema = _schema.properties.options || _schema;


    prompt.get(_schema, function(err, result){
      if(err) {
        logger.error(JSON.stringify(err));
        return;
      }
      logger.info('executed ' + method.magenta);
      cliff.putObject(result);
    });

  } else {

    resource[method](function(err, result){
      if(err) {
        logger.error(JSON.stringify(err));
        return;
      }
      logger.info('executed ' + method.magenta)
      logger.data(result);
    });

  }

};

//
// TODO: prompt actually has a built in prompt.confirm,
// its just not documented. Switch to using this and add usage docs to prompt library
//
function confirm (callback) {
  var property = {
    name: 'yesno',
    message: 'are you sure?',
    validator: /y[es]*|n[o]?/,
    warning: 'Must respond yes or no',
    default: 'yes'
  };
  prompt.get(property, function(err, result){
    if (err || result.yesno !== "yes") {
      logger.warn('action cancelled')
      return;
    }
    callback(null, result);
  });
}
